<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ìŠ¤ë§ˆíŠ¸ íšŒê³„ ê´€ë¦¬</title>
    <style>
        /* --- [ë””ìì¸ ë¦¬ì…‹ ë° ë³€ìˆ˜ ì„¤ì •] --- */
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --text-main: #1f2937;
            --text-sub: #6b7280;
            --border: #e5e7eb;
            --red: #ef4444;
            --blue: #2563eb;
            --green: #10b981;
            --radius: 12px;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Pretendard', -apple-system, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 15px;
            line-height: 1.5;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: var(--bg-card);
            border-radius: var(--radius);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 20px;
            overflow: hidden;
        }

        h1 {
            text-align: center;
            font-size: 1.5rem;
            margin-bottom: 25px;
            color: var(--text-main);
        }

        /* --- [1. ì”ì•¡ ì¹´ë“œ] --- */
        .balance-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--blue) 100%);
            color: white;
            padding: 20px;
            border-radius: var(--radius);
            margin-bottom: 25px;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.3);
        }

        .balance-info h2 { margin: 0; font-size: 0.9rem; opacity: 0.9; font-weight: 400; }
        .balance-info .amount { font-size: 2rem; font-weight: 800; margin-top: 5px; }

        .balance-actions {
            background: rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 8px;
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .balance-actions input {
            width: 100px; padding: 8px; border: none; border-radius: 4px;
            text-align: right; font-weight: bold;
        }
        .btn-white {
            background: white; color: var(--primary); border: none;
            padding: 8px 12px; border-radius: 4px; font-weight: bold; cursor: pointer;
        }

        /* --- [2. ì„¹ì…˜ ê³µí†µ] --- */
        .section-title {
            font-size: 1.1rem; font-weight: 700; margin-bottom: 12px;
            color: var(--text-main); border-left: 4px solid var(--primary);
            padding-left: 10px;
        }

        /* --- [3. ì…ë ¥ í¼] --- */
        .input-grid {
            display: grid;
            gap: 10px;
            grid-template-columns: 140px 100px 1fr 1fr 1.5fr auto 80px;
            margin-bottom: 30px;
            align-items: center;
        }

        input, select {
            padding: 10px; border: 1px solid var(--border); border-radius: 6px;
            font-size: 0.95rem; width: 100%; height: 42px;
        }
        
        .file-label {
            background: #f9fafb; border: 1px solid var(--border);
            border-radius: 6px; cursor: pointer; height: 42px;
            display: flex; align-items: center; justify-content: center; font-size: 1.2rem;
        }
        .file-label:hover { background: #e5e7eb; }

        .btn-primary {
            background: var(--primary); color: white; border: none;
            border-radius: 6px; height: 42px; font-weight: bold; cursor: pointer;
        }
        .btn-primary:hover { background: var(--primary-dark); }

        @media (max-width: 900px) {
            .input-grid {
                grid-template-columns: 1fr 1fr;
                grid-template-areas: 
                    "date type"
                    "price price"
                    "name name"
                    "explan explan"
                    "file btn";
            }
            #inDate { grid-area: date; }
            #inType { grid-area: type; }
            #inPrice { grid-area: price; }
            #inName { grid-area: name; }
            #inExplan { grid-area: explan; }
            .file-label { grid-area: file; }
            .btn-primary { grid-area: btn; }
            
            .balance-card { flex-direction: column; align-items: flex-start; }
            .balance-actions { width: 100%; justify-content: space-between; }
            .balance-actions input { flex: 1; }
        }

        /* --- [4. í…Œì´ë¸” ë° í•„í„°] --- */
        .filter-bar {
            display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap;
        }
        .filter-bar input { width: auto; flex: 1; min-width: 120px; }
        .btn-outline {
            background: white; border: 1px solid var(--border); color: var(--text-main);
            padding: 0 15px; border-radius: 6px; cursor: pointer; height: 42px;
        }

        .table-wrap {
            overflow-x: auto;
            border: 1px solid var(--border); border-radius: 8px;
        }
        table {
            width: 100%; border-collapse: collapse; min-width: 800px;
        }
        th, td {
            padding: 12px; text-align: left; border-bottom: 1px solid var(--border);
            white-space: nowrap; font-size: 0.9rem;
        }
        th { background: #f9fafb; font-weight: 600; color: var(--text-sub); }
        .col-money { text-align: right; font-weight: bold; }
        .income-text { color: var(--primary); }
        .expense-text { color: var(--red); }
        
        .img-btn {
            font-size: 0.75rem; padding: 2px 6px; border: 1px solid var(--border);
            border-radius: 4px; background: white; cursor: pointer;
        }

        /* --- [5. í•˜ë‹¨ íŒŒì¼ ì»¨íŠ¸ë¡¤] --- */
        .file-controls {
            margin-top: 20px; padding-top: 20px; border-top: 1px dashed var(--border);
            display: flex; justify-content: flex-end; gap: 10px; flex-wrap: wrap;
        }
        .file-controls select, .file-controls button { width: auto; height: 45px; }
        
        .btn-green { background: var(--green); color: white; border:none; border-radius: 6px; padding: 0 15px; font-weight: bold; cursor: pointer; }
        .btn-green:hover { background: #059669; }
        .btn-red-outline { background: white; color: var(--red); border: 1px solid var(--red); border-radius: 6px; padding: 0 15px; font-weight: bold; cursor: pointer; }
        .btn-red-outline:hover { background: #fef2f2; }

        /* --- [ëª¨ë‹¬] --- */
        .modal {
            display: none; position: fixed; z-index: 999; left: 0; top: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.8);
            backdrop-filter: blur(2px); overflow-y: auto;
        }
        .modal-content {
            background: white; margin: 10% auto; padding: 25px;
            width: 90%; max-width: 500px; border-radius: 12px; position: relative;
        }
        .close { position: absolute; right: 20px; top: 15px; font-size: 2rem; cursor: pointer; }
        
        .modal-img-view { margin: 10% auto; width: 90%; max-width: 800px; text-align: center; }
        .modal-img-view img { max-width: 100%; border-radius: 8px; margin-bottom: 10px; }

        /* ìˆ˜ì • í¼ */
        .edit-row { margin-bottom: 15px; }
        .edit-row label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; }
        .edit-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        
        .edit-img-list { display: flex; gap: 5px; flex-wrap: wrap; margin-top: 5px; }
        .edit-img-thumb { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; }
        .edit-img-wrapper { position: relative; }
        .btn-del-img {
            position: absolute; top: -5px; right: -5px; width: 20px; height: 20px;
            background: red; color: white; border-radius: 50%; border: none;
            cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center;
        }

        /* ì €ì¥ ëª¨ë‹¬ */
        .save-options { display: flex; gap: 10px; margin-top: 20px; }
        .save-options button { flex: 1; height: 50px; font-size: 1rem; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“’ ìŠ¤ë§ˆíŠ¸ íšŒê³„ ê´€ë¦¬</h1>

    <div class="balance-card">
        <div class="balance-info">
            <h2>í˜„ì¬ ì¹´ë“œ ì”ì•¡ (ìµœì¢…)</h2>
            <div class="amount" id="displayTotalBalance">0ì›</div>
        </div>
        <div class="balance-actions">
            <input type="number" id="inTargetBalance" placeholder="ì‹¤ì œ ì”ì•¡">
            <button class="btn-white" onclick="adjustCurrentBalance()">ë§ì¶¤</button>
        </div>
    </div>

    <div class="section-title">âœï¸ ê±°ë˜ ë‚´ì—­ ì…ë ¥</div>
    <div class="input-grid">
        <input type="date" id="inDate" required>
        <select id="inType" onchange="updateInputStyle()">
            <option value="expense" style="color:#ef4444" selected>ì§€ì¶œ (-)</option>
            <option value="income" style="color:#2563eb">ìˆ˜ì… (+)</option>
        </select>
        <input type="number" id="inPrice" placeholder="ê¸ˆì•¡">
        <input type="text" id="inName" placeholder="ë‚´ì—­ ì´ë¦„">
        <input type="text" id="inExplan" placeholder="ì„¤ëª… (ì„ íƒ)">
        
        <label for="inImage" class="file-label" title="ì´ë¯¸ì§€ ì²¨ë¶€">
            ğŸ“· <input type="file" id="inImage" accept="image/*" multiple>
        </label>

        <button class="btn-primary" onclick="addEntry()">ì¶”ê°€</button>
    </div>

    <div class="section-title">ğŸ“‹ ë‚´ì—­ ì¡°íšŒ</div>
    <div class="filter-bar">
        <input type="text" id="filterName" placeholder="ì´ë¦„ ê²€ìƒ‰..." onkeyup="renderTable()">
        <input type="date" id="filterStartDate" onchange="renderTable()">
        <span style="align-self:center">~</span>
        <input type="date" id="filterEndDate" onchange="renderTable()">
        <button class="btn-outline" onclick="resetFilters()">ì´ˆê¸°í™”</button>
    </div>

    <div class="table-wrap">
        <table>
            <thead>
                <tr>
                    <th onclick="sortTable('date')">ë‚ ì§œ â–¼</th>
                    <th onclick="sortTable('type')">êµ¬ë¶„</th>
                    <th onclick="sortTable('name')">ì´ë¦„</th>
                    <th>ì„¤ëª…</th>
                    <th style="text-align:center">ì‚¬ì§„</th>
                    <th onclick="sortTable('price')" style="text-align:right">ê¸ˆì•¡ â–¼</th>
                    <th style="text-align:right">ì”ì•¡</th>
                    <th style="text-align:center">ê´€ë¦¬</th>
                </tr>
            </thead>
            <tbody id="dataTableBody">
                </tbody>
        </table>
    </div>

    <div class="file-controls">
        <span style="font-size:0.8rem; color:#666; margin-right:auto; align-self:center;">
            * CSV ì €ì¥ ì‹œ ì´ë¯¸ì§€ ë°ì´í„°ë„ í¬í•¨ë©ë‹ˆë‹¤.
        </span>
        <select id="encodingSelect">
            <option value="UTF-8">UTF-8 (ê¸°ë³¸)</option>
            <option value="EUC-KR">EUC-KR (ì—‘ì…€)</option>
        </select>
        
        <input type="file" id="csvFileInput" accept=".csv, text/csv, application/vnd.ms-excel, text/plain" style="display: none;" onchange="handleFileSelect(this)">
        
        <button class="btn-red-outline" onclick="triggerImport('overwrite')">ğŸ“‚ ë®ì–´ì“°ê¸°</button>
        <button class="btn-green" onclick="triggerImport('append')">â• CSV ì¶”ê°€</button>
        <button class="btn-primary" onclick="openSaveModal()">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
    </div>
</div>

<div id="imageModal" class="modal" onclick="if(event.target==this) this.style.display='none'">
    <span class="close" style="position:fixed; color:white; top:20px; right:20px;" onclick="document.getElementById('imageModal').style.display='none'">&times;</span>
    <div id="modalGallery" class="modal-img-view"></div>
</div>

<div id="editModal" class="modal">
    <div class="modal-content">
        <span class="close" style="top:10px; right:15px; color:#333;" onclick="document.getElementById('editModal').style.display='none'">&times;</span>
        <h2 style="margin-top:0;">ë‚´ì—­ ìˆ˜ì •</h2>
        <input type="hidden" id="editId">
        
        <div class="edit-row">
            <label>ë‚ ì§œ</label>
            <input type="date" id="editDate">
        </div>
        <div class="edit-row">
            <label>êµ¬ë¶„</label>
            <select id="editType">
                <option value="expense">ì§€ì¶œ</option>
                <option value="income">ìˆ˜ì…</option>
            </select>
        </div>
        <div class="edit-row">
            <label>ê¸ˆì•¡</label>
            <input type="number" id="editPrice">
        </div>
        <div class="edit-row">
            <label>ì´ë¦„</label>
            <input type="text" id="editName">
        </div>
        <div class="edit-row">
            <label>ì„¤ëª…</label>
            <input type="text" id="editExplan">
        </div>
        <div class="edit-row">
            <label>ì´ë¯¸ì§€ (ì¶”ê°€/ì‚­ì œ)</label>
            <input type="file" id="editImageInput" accept="image/*" multiple style="margin-bottom:5px;">
            <div id="editImageList" class="edit-img-list"></div>
        </div>

        <div class="edit-actions">
            <button class="btn-outline" onclick="document.getElementById('editModal').style.display='none'">ì·¨ì†Œ</button>
            <button class="btn-primary" onclick="saveEdit()">ìˆ˜ì • ì™„ë£Œ</button>
        </div>
    </div>
</div>

<div id="saveModal" class="modal">
    <div class="modal-content" style="text-align:center;">
        <span class="close" style="top:10px; right:15px; color:#333;" onclick="document.getElementById('saveModal').style.display='none'">&times;</span>
        <h2 style="margin-top:0;">ì €ì¥ ë°©ì‹ ì„ íƒ</h2>
        <p style="color:#666;">íŒŒì¼ì„ ì–´ë–»ê²Œ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
        
        <div class="save-options">
            <button class="btn-primary" onclick="processSave('overwrite')">
                ğŸ’¾ ì €ì¥<br><small style="font-weight:normal; opacity:0.8">(ë¶ˆëŸ¬ì˜¨ íŒŒì¼ëª…)</small>
            </button>
            <button class="btn-outline" onclick="processSave('saveas')">
                ğŸ“ ë‹¤ë¥¸ ì´ë¦„ìœ¼ë¡œ<br><small style="font-weight:normal; color:#888">(ìƒˆ íŒŒì¼ëª… ì…ë ¥)</small>
            </button>
        </div>
    </div>
</div>

<script>
    // --- ë°ì´í„° ë³€ìˆ˜ ---
    let accountingData = [];
    let initialBalance = 0;
    let currentSort = { column: 'date', order: 'asc' };
    let currentEditImages = [];
    let importMode = 'overwrite'; 
    let importedFileName = "data.csv"; 

    // --- ì´ˆê¸°í™” ---
    window.onload = function() {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        document.getElementById('inDate').value = `${yyyy}-${mm}-${dd}`;

        loadFromLocalStorage();
        updateInputStyle();
        renderTable();
    };

    function updateInputStyle() {
        const typeSelect = document.getElementById('inType');
        typeSelect.style.color = typeSelect.value === 'income' ? 'var(--blue)' : 'var(--red)';
    }

    // --- í•µì‹¬ ë¡œì§ ---

    // 1. ì”ì•¡ ë§ì¶¤
    function adjustCurrentBalance() {
        const val = document.getElementById('inTargetBalance').value;
        if (val === '') return;
        
        const targetBalance = parseInt(val);
        let netChange = 0;
        accountingData.forEach(item => {
            if (item.type === 'income') netChange += (item.price || 0);
            else netChange -= (item.price || 0);
        });

        initialBalance = targetBalance - netChange;
        document.getElementById('inTargetBalance').value = ''; 
        saveToLocalStorage();
        renderTable(); 
        alert(`í˜„ì¬ ì”ì•¡ì„ ${targetBalance.toLocaleString()}ì›ìœ¼ë¡œ ë§ì·„ìŠµë‹ˆë‹¤.`);
    }

    // 2. ì¶”ê°€
    async function addEntry() {
        const dateStr = document.getElementById('inDate').value;
        const type = document.getElementById('inType').value;
        const price = document.getElementById('inPrice').value;
        const name = document.getElementById('inName').value;
        const explan = document.getElementById('inExplan').value;
        const imageInput = document.getElementById('inImage');

        if (!price || !name || !dateStr) {
            alert("ë‚ ì§œ, ê¸ˆì•¡, ì´ë¦„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
            return;
        }

        let imageArray = [];
        if (imageInput.files && imageInput.files.length > 0) {
            for (let i = 0; i < imageInput.files.length; i++) {
                const compressed = await resizeAndCompressImage(imageInput.files[i]);
                imageArray.push(compressed);
            }
        }

        const [y, m, d] = dateStr.split('-').map(Number);
        
        accountingData.push({
            id: Date.now(),
            type, 
            price: parseInt(price) || 0, 
            name: name || '', 
            explan: explan || '', 
            year: y, month: m, day: d, 
            images: imageArray
        });

        saveToLocalStorage();
        renderTable();
        
        // ì´ˆê¸°í™”
        document.getElementById('inPrice').value = '';
        document.getElementById('inName').value = '';
        document.getElementById('inExplan').value = '';
        document.getElementById('inImage').value = '';
        document.getElementById('inPrice').focus();
    }

    // 3. ì¡°íšŒ ë° ë Œë”ë§
    function renderTable() {
        const tbody = document.getElementById('dataTableBody');
        tbody.innerHTML = '';

        // ë‚ ì§œìˆœ ì •ë ¬ (ë Œë”ë§ & ì”ì•¡ ê³„ì‚°ìš©)
        let sortedData = [...accountingData].sort((a, b) => {
            const da = (a.year||0)*10000 + (a.month||0)*100 + (a.day||0);
            const db = (b.year||0)*10000 + (b.month||0)*100 + (b.day||0);
            return da - db || a.id - b.id;
        });

        // ì”ì•¡ ê³„ì‚° (ì´ ì‹œì ì—ì„œ initialBalanceëŠ” ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì–´ ìˆì–´ì•¼ í•¨)
        let tempBalance = initialBalance;
        sortedData.forEach(item => {
            if (item.type === 'income') tempBalance += (item.price || 0);
            else tempBalance -= (item.price || 0);
            item._calculatedBalance = tempBalance;
        });

        document.getElementById('displayTotalBalance').innerText = tempBalance.toLocaleString() + "ì›";

        // í•„í„°ë§
        const filterName = document.getElementById('filterName').value.toLowerCase();
        const startDateStr = document.getElementById('filterStartDate').value;
        const endDateStr = document.getElementById('filterEndDate').value;

        let displayData = sortedData.filter(item => {
            const itemName = (item.name || "").toLowerCase();
            if (filterName && !itemName.includes(filterName)) return false;
            
            if (startDateStr || endDateStr) {
                const itemVal = (item.year||0)*10000 + (item.month||0)*100 + (item.day||0);
                const startVal = startDateStr ? parseInt(startDateStr.replace(/-/g, '')) : 0;
                const endVal = endDateStr ? parseInt(endDateStr.replace(/-/g, '')) : 99999999;
                if (itemVal < startVal || itemVal > endVal) return false;
            }
            return true;
        });

        // í™”ë©´ ì •ë ¬ (ì‚¬ìš©ì ì„ íƒ)
        displayData.sort((a, b) => {
            let valA, valB;
            if (currentSort.column === 'date') {
                valA = (a.year||0)*10000 + (a.month||0)*100 + (a.day||0);
                valB = (b.year||0)*10000 + (b.month||0)*100 + (b.day||0);
            } else if (currentSort.column === 'price') {
                valA = a.price || 0; valB = b.price || 0;
            } else if (currentSort.column === 'name') {
                valA = (a.name || "").toLowerCase(); valB = (b.name || "").toLowerCase();
            } else { 
                valA = a.type || ""; valB = b.type || "";
            }
            
            if (valA < valB) return currentSort.order === 'asc' ? -1 : 1;
            if (valA > valB) return currentSort.order === 'asc' ? 1 : -1;
            return 0;
        });

        // ê·¸ë¦¬ê¸°
        displayData.forEach(item => {
            const tr = document.createElement('tr');
            const dateStr = `${item.year}-${String(item.month).padStart(2,'0')}-${String(item.day).padStart(2,'0')}`;
            const isInc = item.type === 'income';
            
            let imgBtn = '-';
            let imgCount = 0;
            if (item.images && Array.isArray(item.images)) imgCount = item.images.length;
            else if (item.image) imgCount = 1;

            if (imgCount > 0) {
                imgBtn = `<button class="img-btn" onclick="showImage(${item.id})">ğŸ“·(${imgCount})</button>`;
            }

            tr.innerHTML = `
                <td>${dateStr}</td>
                <td class="${isInc?'income-text':'expense-text'}" style="font-weight:bold">${isInc?'ìˆ˜ì…':'ì§€ì¶œ'}</td>
                <td>${item.name || ''}</td>
                <td style="font-size:0.85rem; color:#666;">${item.explan || ''}</td>
                <td style="text-align:center">${imgBtn}</td>
                <td class="col-money ${isInc?'income-text':'expense-text'}">${isInc?'+':'-'} ${(item.price||0).toLocaleString()}</td>
                <td class="col-money" style="color:#333">${(item._calculatedBalance||0).toLocaleString()}</td>
                <td style="text-align:center">
                    <button class="img-btn" onclick="openEdit(${item.id})">ìˆ˜ì •</button>
                    <button class="img-btn" style="color:red; border-color:red;" onclick="del(${item.id})">ì‚­ì œ</button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        if(displayData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:30px; color:#999;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        }
    }

    // --- ì´ë¯¸ì§€ ì²˜ë¦¬ ---
    function showImage(id) {
        const item = accountingData.find(d => d.id === id);
        if(!item) return;
        
        let imgs = item.images || (item.image ? [item.image] : []);
        if(imgs.length === 0) return;

        const gallery = document.getElementById('modalGallery');
        gallery.innerHTML = '';
        imgs.forEach(src => {
            const img = document.createElement('img');
            img.src = src;
            gallery.appendChild(img);
        });
        document.getElementById('imageModal').style.display = 'block';
    }

    function resizeAndCompressImage(file) {
        return new Promise(resolve => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = e => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const max = 600; 
                    let w = img.width, h = img.height;
                    if(w > h) { if(w > max) { h *= max/w; w = max; } }
                    else { if(h > max) { w *= max/h; h = max; } }
                    canvas.width = w; canvas.height = h;
                    ctx.drawImage(img, 0, 0, w, h);
                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                }
            }
        });
    }

    // --- ìˆ˜ì • ê¸°ëŠ¥ ---
    function openEdit(id) {
        const item = accountingData.find(d => d.id === id);
        if(!item) return;

        document.getElementById('editId').value = item.id;
        document.getElementById('editDate').value = `${item.year}-${String(item.month).padStart(2,'0')}-${String(item.day).padStart(2,'0')}`;
        document.getElementById('editType').value = item.type || 'expense';
        document.getElementById('editPrice').value = item.price;
        document.getElementById('editName').value = item.name;
        document.getElementById('editExplan').value = item.explan;
        document.getElementById('editImageInput').value = '';

        currentEditImages = [];
        if(item.images) currentEditImages = [...item.images];
        else if(item.image) currentEditImages = [item.image];

        renderEditImages();
        document.getElementById('editModal').style.display = 'block';
    }

    function renderEditImages() {
        const container = document.getElementById('editImageList');
        container.innerHTML = '';
        currentEditImages.forEach((src, idx) => {
            const div = document.createElement('div');
            div.className = 'edit-img-wrapper';
            div.innerHTML = `
                <img src="${src}" class="edit-img-thumb">
                <button class="btn-del-img" onclick="removeEditImg(${idx})">&times;</button>
            `;
            container.appendChild(div);
        });
    }

    function removeEditImg(idx) {
        currentEditImages.splice(idx, 1);
        renderEditImages();
    }

    async function saveEdit() {
        const id = parseInt(document.getElementById('editId').value);
        const item = accountingData.find(d => d.id === id);
        if(!item) return;

        const dateStr = document.getElementById('editDate').value;
        const [y, m, d] = dateStr.split('-').map(Number);
        const fileInput = document.getElementById('editImageInput');

        if(fileInput.files.length > 0) {
            for(let i=0; i<fileInput.files.length; i++) {
                const res = await resizeAndCompressImage(fileInput.files[i]);
                currentEditImages.push(res);
            }
        }

        item.year = y; item.month = m; item.day = d;
        item.type = document.getElementById('editType').value;
        item.price = parseInt(document.getElementById('editPrice').value) || 0;
        item.name = document.getElementById('editName').value;
        item.explan = document.getElementById('editExplan').value;
        item.images = currentEditImages;
        delete item.image;

        saveToLocalStorage();
        renderTable();
        document.getElementById('editModal').style.display = 'none';
    }

    function del(id) {
        if(confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            accountingData = accountingData.filter(d => d.id !== id);
            saveToLocalStorage();
            renderTable();
        }
    }

    // --- ì •ë ¬ ---
    function sortTable(col) {
        if(currentSort.column === col) {
            currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
        } else {
            currentSort.column = col;
            currentSort.order = 'asc';
        }
        renderTable();
    }

    function resetFilters() {
        document.getElementById('filterName').value = '';
        document.getElementById('filterStartDate').value = '';
        document.getElementById('filterEndDate').value = '';
        renderTable();
    }

    // --- CSV íŒŒì‹± (Robust) ---
    function parseCSVRow(row) {
        let res = [];
        let cur = '';
        let inQuote = false;
        for(let i=0; i<row.length; i++) {
            let c = row[i];
            if(c === '"') {
                if(inQuote && row[i+1] === '"') { cur += '"'; i++; }
                else { inQuote = !inQuote; }
            } else if(c === ',' && !inQuote) {
                res.push(cur); cur = '';
            } else { cur += c; }
        }
        res.push(cur);
        return res;
    }

    // --- [ëª¨ë°”ì¼ íŒŒì¼ ì„ íƒì„ ìœ„í•œ í•¨ìˆ˜] ---
    function triggerImport(mode) {
        importMode = mode;
        document.getElementById('csvFileInput').value = ''; 
        document.getElementById('csvFileInput').click();
    }

    // [ì¤‘ìš” ìˆ˜ì •] CSV ë¶ˆëŸ¬ì˜¬ ë•Œ ì”ì•¡ ì—­ì‚° ë¡œì§
    function handleFileSelect(input) {
        const file = input.files[0];
        if(!file) return;
        importedFileName = file.name;

        const reader = new FileReader();
        reader.onload = e => {
            const rows = e.target.result.split(/\r?\n/);
            let cnt = 0;
            let tempData = []; // ë°ì´í„°ë¥¼ ë¨¼ì € íŒŒì‹±í•˜ì—¬ ì €ì¥í•  ì„ì‹œ ë°°ì—´

            // 1. ëª¨ë“  í–‰ íŒŒì‹±
            for(let i=1; i<rows.length; i++) {
                if(!rows[i].trim()) continue;
                const cols = parseCSVRow(rows[i]);
                if(cols.length < 6) continue;

                let type='expense', price=0, name='', explan='', y=0, m=0, d=0, imgs=[], storedBal=null;
                
                // ì»¬ëŸ¼ ë§¤í•‘ (index 7: card_balance)
                if(cols.length >= 9) { 
                    type = cols[0]; price = parseInt(cols[1]); name = cols[2]; explan = cols[3];
                    y = parseInt(cols[4]); m = parseInt(cols[5]); d = parseInt(cols[6]);
                    storedBal = cols[7]; // íŒŒì¼ì— ì €ì¥ëœ ê·¸ ë‹¹ì‹œì˜ ì”ì•¡
                    if(cols[8]) imgs = cols[8].split('|||').filter(s=>s.length>20);
                } else if(cols.length >= 8) { 
                    type = cols[0]; price = parseInt(cols[1]); name = cols[2]; explan = cols[3];
                    y = parseInt(cols[4]); m = parseInt(cols[5]); d = parseInt(cols[6]);
                    storedBal = cols[7];
                } else { 
                    price = parseInt(cols[0]); name = cols[1]; explan = cols[2];
                    y = parseInt(cols[3]); m = parseInt(cols[4]); d = parseInt(cols[5]);
                }

                if(!isNaN(price) && !isNaN(y)) {
                    tempData.push({
                        id: Date.now() + i, 
                        type, price, name, explan, year:y, month:m, day:d, images:imgs,
                        _storedBalance: storedBal // ì„ì‹œ ì €ì¥
                    });
                    cnt++;
                }
            }

            // 2. ë‚ ì§œìˆœ ì •ë ¬ (ì—­ì‚°ì„ ìœ„í•´ í•„ìˆ˜)
            tempData.sort((a, b) => {
                const da = a.year*10000 + a.month*100 + a.day;
                const db = b.year*10000 + b.month*100 + b.day;
                return da - db || a.id - b.id;
            });

            // 3. ë®ì–´ì“°ê¸° ëª¨ë“œ: ì²« ë²ˆì§¸ ë°ì´í„°ë¡œ ì´ˆê¸° ì”ì•¡ ì—­ì‚°
            if (importMode === 'overwrite') {
                accountingData = [];
                initialBalance = 0; 

                if (tempData.length > 0) {
                    const firstItem = tempData[0];
                    const recordedBal = parseInt(firstItem._storedBalance);
                    
                    // íŒŒì¼ì— ì”ì•¡ ì •ë³´ê°€ ìˆê³  ìœ íš¨í•œ ìˆ«ìì¸ ê²½ìš° ì—­ì‚° ìˆ˜í–‰
                    if (!isNaN(recordedBal)) {
                        // S_1 = S_0 + delta  =>  S_0 = S_1 - delta
                        // Income: S_0 = recordedBal - price
                        // Expense: S_0 = recordedBal - (-price) = recordedBal + price
                        if (firstItem.type === 'income') {
                            initialBalance = recordedBal - firstItem.price;
                        } else {
                            initialBalance = recordedBal + firstItem.price;
                        }
                    }
                }
            }

            // 4. ë°ì´í„° ë³‘í•©
            accountingData = accountingData.concat(tempData);

            // 5. ì €ì¥ ë° ë Œë”ë§
            saveToLocalStorage();
            renderTable();
            const msg = importMode === 'overwrite' ? 'ë®ì–´ì“°ê¸° ì™„ë£Œ!' : 'ì¶”ê°€í•˜ê¸° ì™„ë£Œ!';
            alert(`${cnt}ê±´ ${msg}\nì”ì•¡ì€ íŒŒì¼ ê¸°ë¡ì„ ê¸°ë°˜ìœ¼ë¡œ ìë™ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            input.value = '';
        };
        reader.readAsText(file, document.getElementById('encodingSelect').value);
    }

    // --- ì €ì¥ ë²„íŠ¼ ëª¨ë‹¬ ---
    function openSaveModal() {
        document.getElementById('saveModal').style.display = 'block';
    }

    function processSave(mode) {
        document.getElementById('saveModal').style.display = 'none';
        if (mode === 'overwrite') {
            exportCSV(importedFileName);
        } else {
            let newName = prompt("ìƒˆë¡œìš´ íŒŒì¼ëª…ì„ ì…ë ¥í•˜ì„¸ìš” (í™•ì¥ì ì œì™¸)", "data_new");
            if (newName) exportCSV(newName + ".csv");
        }
    }

    function exportCSV(filename = "data.csv") {
        let sorted = [...accountingData].sort((a, b) => {
            const da = (a.year||0)*10000 + (a.month||0)*100 + (a.day||0);
            const db = (b.year||0)*10000 + (b.month||0)*100 + (b.day||0);
            return da - db || a.id - b.id;
        });

        let csv = "\uFEFFtype,price,name,explan,year,month,day,card_balance,images\n";
        let bal = initialBalance;

        sorted.forEach(row => {
            if(row.type === 'income') bal += (row.price||0);
            else bal -= (row.price||0);

            const esc = s => `"${String(s || '').replace(/"/g, '""')}"`;
            let imgStr = '';
            if(row.images && row.images.length) imgStr = row.images.join('|||');
            else if(row.image) imgStr = row.image;

            csv += [
                row.type || 'expense',
                row.price || 0,
                esc(row.name),
                esc(row.explan),
                row.year, row.month, row.day,
                bal,
                esc(imgStr)
            ].join(',') + "\n";
        });

        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.click();
    }

    // --- Storage ---
    function saveToLocalStorage() {
        localStorage.setItem('accData', JSON.stringify(accountingData));
        localStorage.setItem('accInitBal', initialBalance);
    }
    function loadFromLocalStorage() {
        const d = localStorage.getItem('accData');
        const b = localStorage.getItem('accInitBal');
        if(d) accountingData = JSON.parse(d);
        if(b) initialBalance = parseInt(b);
    }
</script>

</body>
</html>