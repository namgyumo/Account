<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>íšŒê³„ ê´€ë¦¬ í”„ë¡œê·¸ë¨ (Web Ver.)</title>
    <style>
        /* --- [ë””ìì¸ ë¦¬ì…‹ ë° ë³€ìˆ˜ ì„¤ì •] --- */
        :root {
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --primary-color: #4f46e5; /* ì„¸ë ¨ëœ ì¸ë””ê³  ë¸”ë£¨ */
            --primary-hover: #4338ca;
            --danger-color: #ef4444;
            --success-color: #10b981;
            --text-color: #1f2937;
            --text-light: #6b7280;
            --border-color: #e5e7eb;
            --radius-md: 12px;
            --radius-sm: 8px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, 'Helvetica Neue', 'Segoe UI', 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            line-height: 1.5;
        }

        /* --- [ë ˆì´ì•„ì›ƒ ì»¨í…Œì´ë„ˆ] --- */
        .container {
            width: 100%;
            max-width: 1200px; /* ë„“ì€ í™”ë©´ í™œìš© */
            background-color: var(--card-bg);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow);
            padding: 30px;
            margin-bottom: 40px;
        }

        h1 {
            text-align: center;
            color: var(--text-color);
            font-size: 1.8rem;
            margin-bottom: 30px;
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        /* --- [ì¹´ë“œ ì„¹ì…˜ (ì”ì•¡ ê´€ë¦¬)] --- */
        .balance-section {
            background: linear-gradient(135deg, #4f46e5 0%, #3b82f6 100%);
            color: white;
            padding: 25px;
            border-radius: var(--radius-md);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.3);
            flex-wrap: wrap; /* ë°˜ì‘í˜• ì¤„ë°”ê¿ˆ */
            gap: 20px;
        }

        .balance-info { flex: 1; min-width: 200px; }
        .balance-info h2 { margin: 0; font-size: 0.95rem; font-weight: 500; opacity: 0.9; margin-bottom: 5px; }
        .balance-info .amount { font-size: 2.5rem; font-weight: 800; line-height: 1.2; }

        .balance-input-area {
            display: flex; flex-direction: column; align-items: flex-end;
            background: rgba(255, 255, 255, 0.15);
            padding: 15px; border-radius: var(--radius-sm);
            backdrop-filter: blur(5px);
        }
        .balance-input-area small { color: rgba(255,255,255,0.9); margin-bottom: 8px; font-size: 0.85rem; display: block; text-align: right; }
        .balance-input-row { display: flex; gap: 8px; width: 100%; }
        
        .balance-input-area input {
            width: 100%; max-width: 150px; border: none; padding: 10px; 
            border-radius: var(--radius-sm); text-align: right; font-weight: bold; color: #333;
            font-size: 1rem;
        }
        
        .btn-balance {
            background-color: #fff; color: var(--primary-color); border: none;
            padding: 10px 16px; border-radius: var(--radius-sm); cursor: pointer; 
            font-weight: bold; white-space: nowrap; transition: transform 0.1s;
        }
        .btn-balance:active { transform: scale(0.96); }

        /* --- [ì„¹ì…˜ ê³µí†µ ìŠ¤íƒ€ì¼] --- */
        .section {
            background: #fff;
            margin-bottom: 30px;
            padding: 0; /* ë‚´ë¶€ íŒ¨ë”© ì œê±° (ê¹”ë”í•˜ê²Œ) */
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--text-color);
            display: flex; align-items: center; gap: 8px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--bg-color);
        }

        /* --- [ì…ë ¥ í¼ (ë°˜ì‘í˜• Grid)] --- */
        .input-group {
            display: grid;
            /* PC: í•œ ì¤„ì— ë°°ì¹˜ (ë¹„ìœ¨ ì¡°ì •) */
            grid-template-columns: 150px 110px 1fr 1fr 2fr auto 100px;
            gap: 12px;
            margin-bottom: 10px;
            align-items: stretch;
        }

        /* ê³µí†µ Input/Select/Button ìŠ¤íƒ€ì¼ */
        input, select {
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.2s, box-shadow 0.2s;
            width: 100%;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        button, .file-label {
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
            border-radius: var(--radius-sm);
            display: inline-flex; justify-content: center; align-items: center;
        }

        .btn-primary { background-color: var(--primary-color); color: white; border: none; padding: 12px; }
        .btn-primary:hover { background-color: var(--primary-hover); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        .btn-danger { background-color: white; color: var(--danger-color); border: 1px solid var(--danger-color); padding: 6px 12px; font-size: 0.85rem;}
        .btn-danger:hover { background-color: #fef2f2; }
        
        .btn-outline { background-color: white; border: 1px solid var(--border-color); color: var(--text-color); padding: 8px 15px; }
        .btn-outline:hover { background-color: #f9fafb; border-color: #d1d5db; }

        /* íŒŒì¼ ì²¨ë¶€ ë²„íŠ¼ ê¾¸ë¯¸ê¸° */
        .file-label {
            background-color: #f3f4f6; color: #555; border: 1px solid var(--border-color);
            padding: 0; width: 100%; height: 100%; min-height: 45px;
            font-size: 1.5rem;
        }
        .file-label:hover { background-color: #e5e7eb; }
        input[type="file"] { display: none; }

        /* ìˆ˜ì…/ì§€ì¶œ í°íŠ¸ ìƒ‰ìƒ */
        #inType { font-weight: bold; }
        .type-expense { color: var(--danger-color); }
        .type-income { color: var(--primary-color); }

        /* ë„ì›€ë§ í…ìŠ¤íŠ¸ */
        small { display: block; color: var(--text-light); margin-top: 5px; font-size: 0.9rem; }

        /* --- [í…Œì´ë¸” (ë‚´ì—­ ì¡°íšŒ)] --- */
        .table-container {
            overflow-x: auto; /* ê°€ë¡œ ìŠ¤í¬ë¡¤ í—ˆìš© */
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px; /* ìµœì†Œ ë„ˆë¹„ í™•ë³´ */
        }

        th, td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.95rem;
            white-space: nowrap; /* ì¤„ë°”ê¿ˆ ë°©ì§€ */
        }

        th {
            background-color: #f9fafb;
            color: var(--text-light);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            cursor: pointer;
            user-select: none;
        }
        th:hover { background-color: #f3f4f6; color: var(--primary-color); }
        
        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #f9fafb; }

        .balance-col { font-weight: 700; color: var(--text-color); background-color: #f8fafc; text-align: right; }
        .amount-income { color: var(--primary-color); font-weight: 700; }
        .amount-expense { color: var(--danger-color); }
        .td-right { text-align: right; }

        .img-btn { 
            font-size: 0.8rem; padding: 4px 8px; border: 1px solid #d1d5db; 
            border-radius: 4px; background: white; color: #555; 
        }

        /* --- [í•„í„° ë° íŒŒì¼ ì»¨íŠ¸ë¡¤] --- */
        .filter-bar {
            display: flex; gap: 10px; flex-wrap: wrap;
            background-color: #f8f9fa; padding: 15px;
            border-radius: var(--radius-sm); margin-bottom: 20px;
            align-items: center; border: 1px solid var(--border-color);
        }
        .filter-bar input { width: auto; flex: 1; min-width: 120px; }

        .file-controls {
            margin-top: 30px; padding-top: 20px;
            border-top: 1px dashed var(--border-color);
            display: flex; flex-direction: column; align-items: flex-end; gap: 10px;
        }
        .file-buttons { display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end; }

        /* --- [ëª¨ë‹¬ (íŒì—…)] --- */
        .modal {
            display: none; position: fixed; z-index: 2000;
            left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(3px);
            overflow-y: auto; /* ëª¨ë‹¬ ì „ì²´ ìŠ¤í¬ë¡¤ */
        }
        
        .modal-content, .modal-form-content {
            background-color: #fff; margin: 5% auto; padding: 25px;
            border-radius: var(--radius-md); width: 95%; max-width: 500px;
            position: relative; animation: slideDown 0.3s ease;
        }
        
        .modal-image-container {
            width: 95%; max-width: 800px; margin: 50px auto;
            display: flex; flex-direction: column; gap: 15px;
        }
        .modal-image-container img {
            width: 100%; border-radius: var(--radius-sm);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .close {
            position: fixed; top: 20px; right: 30px;
            color: white; font-size: 40px; font-weight: bold; 
            cursor: pointer; z-index: 2001; text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        /* ìˆ˜ì • í¼ ìŠ¤íƒ€ì¼ */
        .edit-group { margin-bottom: 15px; }
        .edit-group label { display: block; margin-bottom: 6px; font-weight: 600; color: var(--text-color); font-size: 0.95rem; }
        
        .img-edit-list { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .img-edit-item { position: relative; width: 80px; height: 80px; border-radius: 6px; overflow: hidden; border: 1px solid #ddd; }
        .img-edit-item img { width: 100%; height: 100%; object-fit: cover; }
        .img-del-btn {
            position: absolute; top: 0; right: 0; width: 24px; height: 24px;
            background: rgba(239, 68, 68, 0.9); color: white; border: none;
            display: flex; align-items: center; justify-content: center;
            border-bottom-left-radius: 6px; cursor: pointer;
        }

        .modal-actions { display: flex; gap: 10px; margin-top: 25px; justify-content: flex-end; }
        .modal-actions button { flex: 1; max-width: 120px; }

        @keyframes slideDown {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* --- [ëª¨ë°”ì¼ ë°˜ì‘í˜• ë¯¸ë””ì–´ ì¿¼ë¦¬] --- */
        @media (max-width: 900px) {
            /* ì»¨í…Œì´ë„ˆ ì—¬ë°± ì¶•ì†Œ */
            .container { padding: 15px; width: 100%; border-radius: 0; box-shadow: none; margin-bottom: 0; }
            body { padding: 0; background-color: var(--card-bg); }

            /* ì…ë ¥ ê·¸ë£¹: ì„¸ë¡œë¡œ ìŒ“ê¸° */
            .input-group {
                grid-template-columns: 1fr 1fr; /* ë‚ ì§œ, íƒ€ì… ë°˜ë°˜ */
                grid-template-areas: 
                    "date type"
                    "price price"
                    "name name"
                    "explan explan"
                    "file btn";
            }
            #inDate { grid-area: date; }
            #inType { grid-area: type; }
            #inPrice { grid-area: price; }
            #inName { grid-area: name; }
            #inExplan { grid-area: explan; }
            .file-label { grid-area: file; }
            .btn-primary { grid-area: btn; height: 100%; }

            /* ì”ì•¡ ì„¹ì…˜ ì„¸ë¡œ ì •ë ¬ */
            .balance-section { flex-direction: column; align-items: flex-start; gap: 15px; }
            .balance-input-area { width: 100%; align-items: stretch; }
            .balance-input-area input { max-width: none; flex: 1; }
            
            /* í•„í„° ë°” ì„¸ë¡œ ì •ë ¬ */
            .filter-bar { flex-direction: column; align-items: stretch; }
            .filter-bar input { width: 100%; }
            
            /* íŒŒì¼ ë²„íŠ¼ë“¤ */
            .file-buttons { flex-direction: column; }
            .file-buttons button, .file-buttons select { width: 100%; }
        }
        
        /* ë” ì‘ì€ í™”ë©´ (í°) */
        @media (max-width: 480px) {
            h1 { font-size: 1.5rem; margin-bottom: 20px; }
            .balance-info .amount { font-size: 2rem; }
            
            /* í…Œì´ë¸” í°íŠ¸ ì¶•ì†Œ ë° íŒ¨ë”© ì¡°ì ˆ */
            th, td { padding: 10px; font-size: 0.85rem; }
            .btn-outline, .btn-danger { padding: 4px 8px; font-size: 0.8rem; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ’¸ íšŒê³„ ê´€ë¦¬ í”„ë¡œê·¸ë¨</h1>

    <div class="balance-section">
        <div class="balance-info">
            <h2>í˜„ì¬ ì¹´ë“œ ì”ì•¡ (ìµœì¢…)</h2>
            <div class="amount" id="displayTotalBalance">0ì›</div>
        </div>
        <div class="balance-input-area">
            <small>â–¼ ì‹¤ì œ ì”ì•¡ì„ ì…ë ¥í•˜ì—¬ ë§ì¶¤</small>
            <div class="balance-input-row">
                <input type="number" id="inTargetBalance" placeholder="ì‹¤ì œ ì”ì•¡">
                <button class="btn-balance" onclick="adjustCurrentBalance()">ì”ì•¡ ìˆ˜ì •</button>
            </div>
        </div>
    </div>

    <div class="section">
        <div class="section-title">âœï¸ ê±°ë˜ ë‚´ì—­ ì…ë ¥</div>
        <div class="input-group">
            <input type="date" id="inDate" required title="ê±°ë˜ ë‚ ì§œ">
            <select id="inType" onchange="updateInputStyle()">
                <option value="expense" class="type-expense" selected>ì§€ì¶œ (-)</option>
                <option value="income" class="type-income">ìˆ˜ì… (+)</option>
            </select>
            <input type="number" id="inPrice" placeholder="ê¸ˆì•¡ (ì›)" required>
            <input type="text" id="inName" placeholder="ë‚´ì—­ ì´ë¦„" required>
            <input type="text" id="inExplan" placeholder="ì„¤ëª… (ì„ íƒ)">
            
            <label for="inImage" class="file-label" title="ì´ë¯¸ì§€ ì²¨ë¶€ (ì—¬ëŸ¬ì¥)">
                ğŸ“· <input type="file" id="inImage" accept="image/*" multiple>
            </label>

            <button class="btn-primary" onclick="addEntry()">ì¶”ê°€</button>
        </div>
        <small style="padding: 0 5px;">* ë‚ ì§œ ì„ íƒ ì‹œ ê³¼ê±° ë‚´ì—­ë„ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤. ì¹´ë©”ë¼ëŠ” ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥.</small>
    </div>

    <div class="section">
        <div class="section-title">ğŸ“‹ ë‚´ì—­ ì¡°íšŒ</div>
        
        <div class="filter-bar">
            <input type="text" id="filterName" placeholder="ì´ë¦„ ê²€ìƒ‰..." onkeyup="renderTable()">
            <input type="date" id="filterStartDate" onchange="renderTable()">
            <span style="text-align:center;">~</span>
            <input type="date" id="filterEndDate" onchange="renderTable()">
            <button class="btn-outline" onclick="resetFilters()">ğŸ”„ ì´ˆê¸°í™”</button>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th style="width: 12%;" onclick="sortTable('date')" id="th-date">ë‚ ì§œ <span class="sort-icon">â–¼</span></th>
                        <th style="width: 8%;" onclick="sortTable('type')" id="th-type">êµ¬ë¶„</th>
                        <th style="width: 15%;" onclick="sortTable('name')" id="th-name">ì´ë¦„</th>
                        <th style="width: 20%;">ì„¤ëª…</th>
                        <th style="width: 8%; text-align:center;">ì‚¬ì§„</th>
                        <th style="width: 12%; text-align:right;" onclick="sortTable('price')" id="th-price">ê¸ˆì•¡</th>
                        <th style="width: 15%;" class="balance-col">ì”ì•¡</th>
                        <th style="width: 10%; text-align:center;">ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody"></tbody>
            </table>
        </div>
    </div>

    <div class="file-controls">
        <div class="file-buttons">
            <span class="csv-help" style="margin-right:auto; padding: 10px 0;">â€» ì´ë¯¸ì§€ í¬í•¨ CSV ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° ì§€ì›</span>
            <select id="encodingSelect">
                <option value="UTF-8">UTF-8 (ê¸°ë³¸)</option>
                <option value="EUC-KR">EUC-KR (ì—‘ì…€ìš©)</option>
            </select>
            <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleFileSelect(this)">
            <button class="btn-outline" onclick="document.getElementById('csvFileInput').click()">ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <button class="btn-primary" onclick="exportCSV()">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
        </div>
    </div>
</div>

<div id="imageModal" class="modal">
    <span class="close" onclick="closeModal('imageModal')">&times;</span>
    <div id="modalGallery" class="modal-image-container"></div>
</div>

<div id="editModal" class="modal">
    <div class="modal-form-content">
        <h2>ë‚´ì—­ ìˆ˜ì •</h2>
        <input type="hidden" id="editId">
        
        <div class="edit-group">
            <label>ë‚ ì§œ</label>
            <input type="date" id="editDate">
        </div>
        <div class="edit-group">
            <label>êµ¬ë¶„</label>
            <select id="editType">
                <option value="expense">ì§€ì¶œ (-)</option>
                <option value="income">ìˆ˜ì… (+)</option>
            </select>
        </div>
        <div class="edit-group">
            <label>ê¸ˆì•¡</label>
            <input type="number" id="editPrice">
        </div>
        <div class="edit-group">
            <label>ì´ë¦„</label>
            <input type="text" id="editName">
        </div>
        <div class="edit-group">
            <label>ì„¤ëª…</label>
            <input type="text" id="editExplan">
        </div>
        <div class="edit-group">
            <label>ì´ë¯¸ì§€ ê´€ë¦¬ (ì¶”ê°€: íŒŒì¼ì„ íƒ)</label>
            <input type="file" id="editImageInput" accept="image/*" multiple style="margin-bottom:10px;">
            <div id="editImageList" class="img-edit-list"></div>
        </div>

        <div class="modal-actions">
            <button class="btn-outline" onclick="closeModal('editModal')">ì·¨ì†Œ</button>
            <button class="btn-primary" onclick="saveEdit()">ì €ì¥ì™„ë£Œ</button>
        </div>
    </div>
</div>

<script>
    // --- Data Structure ---
    // Item: { id, year, month, day, price, name, explan, type, images: [base64_1, base64_2, ...] }
    // ê¸°ì¡´ ë‹¨ì¼ image í•„ë“œëŠ” images ë°°ì—´ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜í•˜ì—¬ ì‚¬ìš©
    let accountingData = [];
    let initialBalance = 0; 
    let currentSort = { column: 'date', order: 'asc' }; 
    
    // ìˆ˜ì • ì‹œ ì„ì‹œë¡œ ì´ë¯¸ì§€ ìƒíƒœë¥¼ ì €ì¥í•  ë°°ì—´
    let currentEditImages = [];

    window.onload = function() {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        document.getElementById('inDate').value = `${yyyy}-${mm}-${dd}`;

        loadFromLocalStorage();
        updateInputStyle();
        renderTable();
    };

    function updateInputStyle() {
        const typeSelect = document.getElementById('inType');
        typeSelect.style.color = typeSelect.value === 'income' ? 'var(--primary-color)' : 'var(--danger-color)';
    }

    // ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì§• & ì••ì¶•
    function resizeAndCompressImage(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = function(event) {
                const img = new Image();
                img.src = event.target.result;
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const MAX_WIDTH = 500, MAX_HEIGHT = 500;
                    let width = img.width, height = img.height;

                    if (width > height) {
                        if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                    } else {
                        if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; }
                    }
                    canvas.width = width; canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                };
            };
        });
    }

    function adjustCurrentBalance() {
        const val = document.getElementById('inTargetBalance').value;
        if (val === '') return;
        const targetBalance = parseInt(val);
        let netChange = 0;
        accountingData.forEach(item => {
            if (item.type === 'income') netChange += item.price;
            else netChange -= item.price;
        });
        initialBalance = targetBalance - netChange;
        document.getElementById('inTargetBalance').value = ''; 
        saveToLocalStorage();
        renderTable(); 
        alert(`í˜„ì¬ ì”ì•¡ì„ ${targetBalance.toLocaleString()}ì›ìœ¼ë¡œ ë§ì·„ìŠµë‹ˆë‹¤.`);
    }

    // [ìˆ˜ì •ë¨] ì…ë ¥ ê¸°ëŠ¥ (ë‹¤ì¤‘ ì´ë¯¸ì§€ ì²˜ë¦¬)
    async function addEntry() {
        const dateStr = document.getElementById('inDate').value;
        const type = document.getElementById('inType').value;
        const price = document.getElementById('inPrice').value;
        const name = document.getElementById('inName').value;
        const explan = document.getElementById('inExplan').value;
        const imageInput = document.getElementById('inImage');

        if (!price || !name || !dateStr) {
            alert("ë‚ ì§œ, ê¸ˆì•¡, ì´ë¦„ì€ í•„ìˆ˜ ì…ë ¥ì…ë‹ˆë‹¤.");
            return;
        }

        // ì—¬ëŸ¬ ì´ë¯¸ì§€ ì²˜ë¦¬
        let imageArray = [];
        if (imageInput.files && imageInput.files.length > 0) {
            for (let i = 0; i < imageInput.files.length; i++) {
                const compressed = await resizeAndCompressImage(imageInput.files[i]);
                imageArray.push(compressed);
            }
        }

        const [y, m, d] = dateStr.split('-').map(Number);
        const newElement = {
            id: Date.now(),
            type, price: parseInt(price), name, explan, year: y, month: m, day: d, 
            images: imageArray // ë°°ì—´ë¡œ ì €ì¥
        };

        accountingData.push(newElement);
        saveToLocalStorage();
        renderTable();
        
        document.getElementById('inPrice').value = '';
        document.getElementById('inName').value = '';
        document.getElementById('inExplan').value = '';
        document.getElementById('inImage').value = ''; 
        document.getElementById('inPrice').focus();
    }

    function sortTable(column) {
        if (currentSort.column === column) {
            currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
        } else {
            currentSort.column = column;
            currentSort.order = 'asc';
        }
        renderTable();
    }

    function updateSortUI() {
        ['date', 'type', 'price', 'name'].forEach(col => {
            const th = document.getElementById(`th-${col}`);
            if(th) {
                const icon = th.querySelector('.sort-icon');
                th.classList.remove('active-sort');
                icon.innerText = 'â–¼';
                if (currentSort.column === col) {
                    th.classList.add('active-sort');
                    icon.innerText = currentSort.order === 'asc' ? 'â–²' : 'â–¼';
                }
            }
        });
    }

    function renderTable() {
        const tbody = document.getElementById('dataTableBody');
        tbody.innerHTML = '';

        let sortedForCalc = [...accountingData].sort((a, b) => {
            const dateA = a.year * 10000 + a.month * 100 + a.day;
            const dateB = b.year * 10000 + b.month * 100 + b.day;
            if (dateA !== dateB) return dateA - dateB;
            return a.id - b.id;
        });

        let tempBalance = initialBalance; 
        sortedForCalc.forEach(item => {
            if (item.type === 'income') tempBalance += item.price;
            else tempBalance -= item.price;
            item._calculatedBalance = tempBalance;
        });

        document.getElementById('displayTotalBalance').innerText = tempBalance.toLocaleString() + "ì›";

        const filterName = document.getElementById('filterName').value.toLowerCase();
        const startDateStr = document.getElementById('filterStartDate').value;
        const endDateStr = document.getElementById('filterEndDate').value;

        let displayData = sortedForCalc.filter(item => {
            if (filterName && !item.name.toLowerCase().includes(filterName)) return false;
            if (startDateStr || endDateStr) {
                const itemDateVal = item.year * 10000 + item.month * 100 + item.day;
                const startVal = startDateStr ? parseInt(startDateStr.replace(/-/g, '')) : 0;
                const endVal = endDateStr ? parseInt(endDateStr.replace(/-/g, '')) : 99999999;
                if (itemDateVal < startVal || itemDateVal > endVal) return false;
            }
            return true;
        });

        displayData.sort((a, b) => {
            let valA, valB;
            if (currentSort.column === 'date') {
                valA = a.year * 10000 + a.month * 100 + a.day; valB = b.year * 10000 + b.month * 100 + b.day;
            } else if (currentSort.column === 'price') {
                valA = a.price; valB = b.price;
            } else if (currentSort.column === 'name') {
                valA = a.name.toLowerCase(); valB = b.name.toLowerCase();
            } else if (currentSort.column === 'type') {
                valA = a.type || 'expense'; valB = b.type || 'expense';
            }
            if (valA < valB) return currentSort.order === 'asc' ? -1 : 1;
            if (valA > valB) return currentSort.order === 'asc' ? 1 : -1;
            return 0;
        });

        updateSortUI();

        displayData.forEach(item => {
            const tr = document.createElement('tr');
            const dateStr = `${item.year}-${String(item.month).padStart(2, '0')}-${String(item.day).padStart(2, '0')}`;
            const isIncome = item.type === 'income';
            const typeText = isIncome ? 'ìˆ˜ì…' : 'ì§€ì¶œ';
            const priceClass = isIncome ? 'amount-income' : 'amount-expense';
            const pricePrefix = isIncome ? '+' : '-';

            // ì´ë¯¸ì§€ ë²„íŠ¼ ë¡œì§ (ë°°ì—´ í™•ì¸)
            let imgHtml = '-';
            let imgCount = 0;
            if (item.images && Array.isArray(item.images)) {
                imgCount = item.images.length;
            } else if (item.image) { // êµ¬ë²„ì „ ë°ì´í„° í˜¸í™˜
                imgCount = 1;
            }

            if (imgCount > 0) {
                imgHtml = `<button class="img-btn" onclick="showImage('${item.id}')">ğŸ“·ë³´ê¸°(${imgCount})</button>`;
            }

            tr.innerHTML = `
                <td>${dateStr}</td>
                <td style="color: ${isIncome ? 'blue' : 'red'}; font-size: 0.9rem;">${typeText}</td>
                <td>${item.name}</td>
                <td>${item.explan}</td>
                <td style="text-align:center;">${imgHtml}</td>
                <td class="${priceClass} td-right">${pricePrefix}${item.price.toLocaleString()}ì›</td>
                <td class="balance-col">${item._calculatedBalance.toLocaleString()}ì›</td>
                <td class="actions">
                    <button class="action-btn btn-outline" onclick="openEditModal(${item.id})">ìˆ˜ì •</button>
                    <button class="action-btn btn-danger" onclick="deleteEntry(${item.id})">ì‚­ì œ</button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        if (displayData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding: 20px;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        }
    }

    // --- Modal Functions (View) ---
    function showImage(id) {
        const item = accountingData.find(d => d.id == id);
        if (!item) return;

        // ì´ë¯¸ì§€ ë°°ì—´ í™•ë³´
        let imgs = [];
        if (item.images && Array.isArray(item.images)) {
            imgs = item.images;
        } else if (item.image) {
            imgs = [item.image];
        }

        if (imgs.length > 0) {
            const modal = document.getElementById("imageModal");
            const gallery = document.getElementById("modalGallery");
            gallery.innerHTML = ''; // ì´ˆê¸°í™”

            imgs.forEach(src => {
                const imgTag = document.createElement('img');
                imgTag.src = src;
                gallery.appendChild(imgTag);
            });

            modal.style.display = "block";
        }
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = "none";
    }
    
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = "none";
        }
    }

    // --- Edit Feature (Modal) with Multi-Image Support ---
    
    function openEditModal(id) {
        const item = accountingData.find(d => d.id == id);
        if (!item) return;

        document.getElementById('editId').value = item.id;
        document.getElementById('editDate').value = `${item.year}-${String(item.month).padStart(2, '0')}-${String(item.day).padStart(2, '0')}`;
        document.getElementById('editType').value = item.type || 'expense';
        document.getElementById('editPrice').value = item.price;
        document.getElementById('editName').value = item.name;
        document.getElementById('editExplan').value = item.explan;
        
        document.getElementById('editImageInput').value = ''; 

        // í˜„ì¬ ì´ë¯¸ì§€ ë°°ì—´ ë³µì‚¬í•´ì„œ ì„ì‹œ ì €ì¥
        if (item.images && Array.isArray(item.images)) {
            currentEditImages = [...item.images];
        } else if (item.image) {
            currentEditImages = [item.image];
        } else {
            currentEditImages = [];
        }

        renderEditImages(); // ì´ë¯¸ì§€ ëª©ë¡ ê·¸ë¦¬ê¸°
        document.getElementById('editModal').style.display = 'block';
    }

    // ìˆ˜ì • íŒì—… ë‚´ ì´ë¯¸ì§€ ëª©ë¡ ë Œë”ë§
    function renderEditImages() {
        const container = document.getElementById('editImageList');
        container.innerHTML = '';

        currentEditImages.forEach((src, index) => {
            const div = document.createElement('div');
            div.className = 'img-edit-item';
            
            const img = document.createElement('img');
            img.src = src;
            
            const btn = document.createElement('button');
            btn.className = 'img-del-btn';
            btn.innerHTML = '&times;';
            btn.onclick = function() { removeImageFromEdit(index); }; // ì‚­ì œ ê¸°ëŠ¥

            div.appendChild(img);
            div.appendChild(btn);
            container.appendChild(div);
        });
    }

    function removeImageFromEdit(index) {
        currentEditImages.splice(index, 1);
        renderEditImages();
    }

    async function saveEdit() {
        const id = parseInt(document.getElementById('editId').value);
        const item = accountingData.find(d => d.id === id);
        if (!item) return;

        const dateStr = document.getElementById('editDate').value;
        const [y, m, d] = dateStr.split('-').map(Number);

        item.year = y;
        item.month = m;
        item.day = d;
        item.type = document.getElementById('editType').value;
        item.price = parseInt(document.getElementById('editPrice').value) || 0;
        item.name = document.getElementById('editName').value;
        item.explan = document.getElementById('editExplan').value;

        // 1. ê¸°ì¡´ ë¦¬ìŠ¤íŠ¸ì—ì„œ ì‚­ì œëœ ê²ƒì€ ë°˜ì˜ë¨ (currentEditImages)
        // 2. ìƒˆë¡œ ì¶”ê°€ëœ íŒŒì¼ ì²˜ë¦¬
        const fileInput = document.getElementById('editImageInput');
        if (fileInput.files.length > 0) {
            for (let i = 0; i < fileInput.files.length; i++) {
                const compressed = await resizeAndCompressImage(fileInput.files[i]);
                currentEditImages.push(compressed);
            }
        }

        item.images = currentEditImages; // ìµœì¢… ë°˜ì˜
        // êµ¬ë²„ì „ í˜¸í™˜ì„±ì„ ìœ„í•´ image í•„ë“œëŠ” ë¹„ìš°ê±°ë‚˜ ì²«ë²ˆì§¸ë¡œ ì„¤ì • (ì—¬ê¸°ì„  ê·¸ëƒ¥ ë‘ )
        delete item.image; 

        saveToLocalStorage();
        renderTable();
        closeModal('editModal');
    }

    function deleteEntry(id) {
        if (!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        accountingData = accountingData.filter(item => item.id !== id);
        saveToLocalStorage();
        renderTable();
    }

    // --- Utilities ---
    function resetFilters() {
        document.getElementById('filterName').value = '';
        document.getElementById('filterStartDate').value = '';
        document.getElementById('filterEndDate').value = '';
        currentSort = { column: 'date', order: 'asc' };
        renderTable();
    }

    function saveToLocalStorage() {
        localStorage.setItem('accountingData', JSON.stringify(accountingData));
        localStorage.setItem('initialBalance', initialBalance.toString());
    }

    function loadFromLocalStorage() {
        const data = localStorage.getItem('accountingData');
        const bal = localStorage.getItem('initialBalance');
        if (data) {
            accountingData = JSON.parse(data);
            accountingData.forEach(item => {
                if (!item.type) item.type = 'expense';
                // ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜: image(string) -> images(array)
                if (item.image && (!item.images || item.images.length === 0)) {
                    item.images = [item.image];
                }
            });
        }
        if (bal) {
            initialBalance = parseInt(bal);
        }
    }

    // --- CSV Export (ë‹¤ì¤‘ ì´ë¯¸ì§€ í¬í•¨) ---
    function exportCSV() {
        let sorted = [...accountingData].sort((a, b) => {
            const dateA = a.year * 10000 + a.month * 100 + a.day;
            const dateB = b.year * 10000 + b.month * 100 + b.day;
            if (dateA !== dateB) return dateA - dateB;
            return a.id - b.id;
        });

        // ì´ë¯¸ì§€ëŠ” ||| ë¡œ êµ¬ë¶„í•˜ì—¬ í•˜ë‚˜ì˜ ì…€ì— ì €ì¥
        let csvContent = "\uFEFFtype,price,name,explan,year,month,day,card_balance,images\n";
        let tempBal = initialBalance;

        sorted.forEach(row => {
            if (row.type === 'income') tempBal += row.price;
            else tempBal -= row.price;

            const escapeCSV = (str) => {
                if (!str) return '""';
                return '"' + String(str).replace(/"/g, '""') + '"';
            };

            // ì´ë¯¸ì§€ ë°°ì—´ì„ êµ¬ë¶„ìë¡œ í•©ì¹¨
            let imgString = "";
            if (row.images && row.images.length > 0) {
                imgString = row.images.join('|||');
            } else if (row.image) {
                imgString = row.image;
            }

            const rowString = [
                row.type || 'expense',
                row.price,
                escapeCSV(row.name),
                escapeCSV(row.explan),
                row.year,
                row.month,
                row.day,
                tempBal,
                escapeCSV(imgString) 
            ].join(",");
            csvContent += rowString + "\n";
        });

        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", "data.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // --- CSV Import (ë‹¤ì¤‘ ì´ë¯¸ì§€ í¬í•¨) ---
    function handleFileSelect(input) {
        const file = input.files[0];
        if (!file) return;

        const encoding = document.getElementById('encodingSelect').value;
        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result;
            const rows = text.split(/\r?\n/);
            let successCount = 0;
            
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (!row.trim()) continue;
                const matches = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
                let cols = [];
                if (matches) {
                    cols = matches.map(m => m.replace(/^"|"$/g, '').replace(/""/g, '"'));
                } else {
                    cols = row.split(',').map(s => s.trim());
                }
                
                if (cols.length < 6) continue;
                
                let type, price, name, explan, year, month, day, images = [];

                if (cols.length >= 9) { 
                    type = cols[0]; price = parseInt(cols[1]); name = cols[2]; explan = cols[3];
                    year = parseInt(cols[4]); month = parseInt(cols[5]); day = parseInt(cols[6]);
                    // cols[7] balance
                    let imgRaw = cols[8];
                    if (imgRaw) {
                        // ||| êµ¬ë¶„ìë¡œ ë¶„ë¦¬
                        images = imgRaw.split('|||').filter(s => s.length > 20);
                    }
                } else if (cols.length >= 8) { 
                    // êµ¬ë²„ì „ í˜¸í™˜ (ì´ë¯¸ì§€ 1ê°œì¸ ê²½ìš°ë„ ìˆì„ ìˆ˜ ìˆìŒ)
                    type = cols[0]; price = parseInt(cols[1]); name = cols[2]; explan = cols[3];
                    year = parseInt(cols[4]); month = parseInt(cols[5]); day = parseInt(cols[6]);
                } else { 
                    type = 'expense'; price = parseInt(cols[0]); name = cols[1]; explan = cols[2];
                    year = parseInt(cols[3]); month = parseInt(cols[4]); day = parseInt(cols[5]);
                }

                if (!isNaN(price) && !isNaN(year)) {
                    accountingData.push({
                        id: Date.now() + i,
                        type: type || 'expense', price, name, explan, year, month, day,
                        images: images
                    });
                    successCount++;
                }
            }
            saveToLocalStorage();
            renderTable();
            alert(`${successCount}ê°œì˜ ë‚´ì—­ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!\nì”ì•¡ì€ í˜„ì¬ ì„¤ì •ëœ ê¸°ì¤€ì— ë§ì¶° ì¬ê³„ì‚°ë©ë‹ˆë‹¤.`);
            input.value = '';
        };
        reader.readAsText(file, encoding);
    }
</script>

</body>
</html>